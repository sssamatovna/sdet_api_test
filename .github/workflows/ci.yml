name: API Test CI

on:
  push:
    branches:
      - master
      - feature/api-tests
  pull_request:
    branches:
      - master

jobs:
  run_api_tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ‚öôÔ∏è Install dependencies
      run: |
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ pip
        python -m pip install --upgrade pip
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        pip install pytest pytest-xdist allure-pytest pydantic python-dotenv requests

    - name: üõ†Ô∏è Setup .env variables
      env:
        API_HOST: ${{ vars.API_HOST || 'http://localhost:8080' }}
      run: |
        # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏, 
        # —á—Ç–æ–±—ã –µ–≥–æ –º–æ–≥–ª–∞ –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∏–∫—Å—Ç—É—Ä–∞ base_url –≤ conftest.py
        echo "API_HOST=${API_HOST}" > .env
        cat .env # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)

    - name: Run Pytest and generate Allure results
      run: |
        pytest tests/ --alluredir=allure-results

    - name: üíæ Upload Allure Report Artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: allure-report
        path: allure-results
        retention-days: 7

    - name: Deploy Allure Report (Optional)
      uses: simple-elf/allure-action@v1.5
      if: always()
      with:
        allure_results: allure-results
        gh_pages: gh-pages

    - name: Deploy report to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      if: github.ref == 'refs/heads/master'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: allure-history